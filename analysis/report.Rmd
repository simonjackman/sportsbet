---
title: "Betting odds and the 2022 Australian election"
author: "Professor Simon Jackman"
date: "`r format(Sys.time(), '%e %B %Y')`"
output:
  bookdown::html_document2:
    css: preamble.css
    toc: yes
    toc_float: yes  
    self-contained: true
fontsize: 11pt
link-citations: no
affiliation: University of Sydney
bibliography: betting.bib
editor_options:
  markdown:
    wrap: 80
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,warnings=FALSE,message = FALSE)
options(htmltools.dir.version = FALSE)

library(tidyverse)
library(here)
library(fst)
library(r2d3)
options(r2d3.shadow=FALSE)
library(DT)
theStates <- c("ACT","NT","QLD","NSW","VIC","TAS","SA","WA")
```


```{r read-data-files}
theFiles <- list.files(here("data"),pattern="fst$",full.names = TRUE)
d <- lapply(theFiles,read.fst)
d <- bind_rows(d)

## correct spelling error by Sportsbet
d <- d %>%
  mutate(event = ifelse(event=="Capriconia (QLD)","Capricornia (QLD)",event))

lastDate <- strftime(max(d$datetime),"%l%p %d %B")

## NATIONAL MARKET
tab <- d %>% 
  filter(grepl(lab,pattern="Next Sworn")) %>% 
    filter(datetime==max(datetime)) %>%
  mutate(prob=prob*100) %>%
  mutate(prob_nls = ifelse(prob>10,prob,0),
         prob_nls = prob_nls/sum(prob_nls)*100) %>%
  mutate(prices = sprintf(prices,fmt="%4.2f")) %>%
  select(Result=outcomes,Price=prices,`IPOW`=prob,prob_nls)

alp_win_prob_nls <- tab$IPOW[1]/sum(tab$IPOW[1:2])*100

load(here("data/aec_historic_2022.RData"))

## HOUSE MARKETS, SUMMARY
dsum <- d %>%
  filter(lab %in% theStates) %>%
  group_by(event) %>%
  filter(datetime==max(datetime)) %>%
  ungroup() %>%
  mutate(event = str_squish(str_remove(event,pattern="\\([A-Z]{1,}\\).*$"))) %>%
  mutate(outcomes_collapsed = case_when(
    outcomes=="Coalition" ~ "LNP",
    outcomes=="Green" ~ "GRN",
    outcomes=="Labor" ~ "ALP",
    outcomes=="One Nation" ~ "PHON",
    grepl(outcomes,pattern="Indep") ~ "IND",
    TRUE ~ "OTH"
  ))

s <- dsum %>%
  group_by(event,outcomes_collapsed) %>%
  mutate(prob = sum(prob,na.rm=TRUE)) %>%
  ungroup() %>%
  group_by(event) %>%
  mutate(prob_nls = ifelse(prob<.10,0,prob),
         prob_nls = prob_nls/sum(prob_nls)) %>%
  ungroup() %>%
  group_by(outcomes_collapsed) %>%
  summarise(`Expected Seats`=sum(prob,na.rm=TRUE),
            `Expected Seats (no long-shots)` = sum(prob_nls,na.rm=TRUE)) %>%
  ungroup() %>%
  rename(Party = outcomes_collapsed) %>%
  arrange(Party)

s2 <- dsum %>% 
  group_by(event) %>% 
  summarise(leader=outcomes_collapsed[which.max(prob)]) %>% 
  ungroup() %>% 
  count(leader) %>% 
  ungroup() %>%
  rename(Party = leader,Leads=n) %>%
  arrange(Party) 

s <- left_join(s,s2,by="Party") %>%
  mutate(Leads=replace_na(Leads,0))


h <- aec_historic_2022 %>%
  filter(!is.na(PartyAb)) %>%
  rename(outcomes=PartyAb,Division=DivisionName) %>%
  mutate(outcomes_collapsed = case_when(
    outcomes %in% c("LNP","LP","CLP","NP") ~ "LNP",
    outcomes=="GRN" ~ "GRN",
    outcomes=="IND" ~ "IND",
    outcomes=="ALP" ~ "ALP",
    TRUE ~ "OTH")
  ) %>%
  group_by(State,Division,type,outcomes_collapsed) %>%
  summarise(Votes = sum(Votes)) %>%
  ungroup() %>%
  group_by(State,Division,type) %>%
  mutate(p=Votes/sum(Votes)) %>%
  ungroup()

plotData <- left_join(h,
                      d %>%
                        filter(lab %in% theStates) %>%
                        group_by(event) %>%
                        filter(datetime==max(datetime)) %>%
                        mutate(prob_nls = ifelse(prob<.10,0,prob),
                               prob_nls = prob_nls/sum(prob_nls)) %>%
                        ungroup() %>%
                        mutate(event = str_squish(str_remove(event,pattern="\\([A-Z]{1,}\\).*$"))) %>%
                        mutate(outcomes_collapsed = case_when(
                          outcomes=="Coalition" ~ "LNP",
                          outcomes=="Green" ~ "GRN",
                          outcomes=="Labor" ~ "ALP",
                          grepl(outcomes,pattern="Indep") ~ "IND",
                          TRUE ~ "OTH"
                        )) %>%
                        mutate(prob=prob_nls) %>%
                        group_by(event,outcomes_collapsed) %>%
                        mutate(prob = sum(prob,na.rm=TRUE)*100) %>%
                        ungroup() %>%
                        rename(State=lab,Division=event),
                      by=c("State","Division","outcomes_collapsed")
)

tmp <- plotData %>% 
  filter(type=="tcp" & outcomes_collapsed %in% c("ALP","LNP")) %>%
  mutate(votes=p*100)
save("tmp",file=here("data/linkedScatter.RData"))

tab_change <- plotData %>% 
  filter(type=="tcp") %>% 
  group_by(Division) %>% 
  summarise(incumbent = outcomes_collapsed[which.max(p)],
            incumbent_tcp = p[which.max(p)],
            incumbent_prob = prob[which.max(p)],
            favorite = outcomes_collapsed[which.max(prob)]) %>% 
  ungroup()

tab_change <- left_join(
  tab_change %>% filter(favorite!=incumbent | incumbent_prob<.5),
  plotData %>% select(Division,State) %>% distinct(),
  by="Division") %>%
  arrange(incumbent_prob)


ind_leads <- dsum %>% 
    group_by(event) %>% 
    summarise(leader=outcomes_collapsed[which.max(prob)]) %>% 
    ungroup() %>% filter(leader=="IND") %>% pull(event)
```

# Summary

As of `r lastDate`, Sportsbet betting odds imply:

::: {#summary .highlights}
- `r ifelse(alp_win_prob_nls>50,"Labor","Coalition")` to form the next government with 
`r round(max(c(alp_win_prob_nls,100-alp_win_prob_nls)),1)`% probability.

- `r nrow(tab_change)` seats changing hands in the House of Representatives; see section \@ref(seats-changing-hands) below.

- Labor leads in `r s$Leads[s$Party=="ALP"]` seats.

- Independents favourites in `r s$Leads[s$Party=="IND"]` seats: `r ind_leads`.

:::

This analysis examines Sportsbet odds in various election betting markets for the
2022 Australian federal election.

We convert odds into *implied probabilities of winning* (IPOW) using a procedure
explained in the Appendix.

In the tables and charts below, we express IPOWs as percentages.

# Next government market

As of `r lastDate`:

```{r next-government-market}
knitr::kable(tab,
             digits=c(0,2,1,1),
             align=c("l","r","r","r"),
             col.names = c("Result","Price","IPOW","IPOW<br>(no long shots)"))
```

Time series:
```{r time-series}
library(highcharter)
hdata <- d %>% 
  filter(grepl(lab,pattern="Next Sworn")) %>%
  mutate(prob=prob*100) %>%
  mutate(prob_nls = ifelse(prob>10,prob,0)) %>%
  group_by(datetime) %>%
  mutate(prob_nls = prob_nls/sum(prob_nls)*100) %>%
  ungroup() %>%
  filter(outcomes!="Any Other")

hchart(hdata,
       hcaes(x = as.Date(datetime),
             y = prob_nls,
             group=outcomes),
       type="line") %>%
  hc_xAxis(title=list(text=""),
           dateTimeLabelFormats=list("day"="%e %b")) %>%
  hc_colors(colors=c("#009de3","#ed1b35")) %>%
  hc_yAxis(title=list(text="IPOW")) %>%
  hc_tooltip(valueDecimals=1,valueSuffix="%") %>%
  hc_plotOptions(line=list(marker=list(symbol="circle")))
```


# House of Representatives seats

## Expected seat counts

We compute expected seat counts by summing the seat-specific probabilities of
winning implied by Sportsbet's odds as at `r lastDate`.

The second column of seat counts removes "long-shots", where the implied probability of winning
is less than 10%; we do so by setting the probability of these candidates/parties to zero and renormalizing the remaining non-zero IPOWs to sum to one in each seat.   This focuses attention on differences between parties and candidates with more realistic prospects of winning.

The third column of counts shows where the indicated party has the highest
IPOW.

```{r house-summary}

knitr::kable(s,digits=1,
             col.names = c("Party",
                           "Expected<br>Seats",
                           "Expected<br>Seats<br>(no long-shots)",
                           "Seats<br>where<br>favourite"))
```

## Seat-by-seat IPOWs 

We remove long-shots (IPOWs < 10%) and renormalise the remaining IPOWS to sum to 100% in each seat:

```{r}
tab <- d %>%
  filter(lab %in% theStates) %>%
  group_by(event) %>%
  filter(datetime==max(datetime)) %>%
  mutate(prob_nls = ifelse(prob<.10,0,prob),
         prob_nls = prob_nls/sum(prob_nls)) %>%
  ungroup() %>%
  mutate(event = str_remove(event,pattern="\\([A-Z]{1,}\\).*$")) %>%
  mutate(outcomes_collapsed = case_when(
    outcomes=="Coalition" ~ "LNP",
    outcomes=="Green" ~ "GRN",
    outcomes=="Labor" ~ "ALP",
    outcomes=="One Nation" ~ "PHON",
    grepl(outcomes,pattern="Indep") ~ "IND",
    TRUE ~ "OTH"
  )) %>%
  mutate(prob=prob_nls) %>%
  group_by(event,outcomes_collapsed) %>%
  mutate(prob = sum(prob,na.rm=TRUE)*100) %>%
  ungroup() %>%
  pivot_wider(id_cols=c("lab","event"),
              names_from = "outcomes_collapsed",
              values_from = "prob")

datatable(tab,
          rownames=FALSE,
          colnames=c('State'="lab","Division"="event"),
          options=list(style="bootstrap4"),
          caption = "Probability of Winning implied by Sportsbet prices (long shots removed)")  %>%
  formatRound(columns=c('ALP','LNP','GRN',"IND","PHON","OTH"),1)
```


## Relationship between IPOW and seat margins

With long-shot probabilities again set to zero, we examine the relationship between IPOWs and two-candidate preferred results in each seat, using 2019 results of notional results in the event of electoral redistributions since 2019.

Current Sportsbet prices are broadly consistent with the assumption of a 4 to 5 percentage point TCP swing from the Coalition to Labor.  That is, IPOWs of 50% are around a 54-46 Coalition/Labor split of the 2019 or notional 2022 TPP vote.

Roll a mouse or pointing device over individual data points for more information.

```{r linkedScatter}
load(here("data/linkedScatter.RData"))

if(!file.exists(here("js/d3-tip.js"))){
  download.file("https://cdn.jsdelivr.net/gh/bumbeishvili/d3-tip-for-v6@4/d3-tip.min.js", 
                here("js/d3-tip.js"))
}

library(mgcv)
library(modelr)
m <- tmp %>%
  group_by(outcomes_collapsed) %>%
  nest() %>%
  mutate(m=map(data,~gam(prob ~ s(votes),data=.x)),
         yhat=map2(.x=data,
                   .y=m,
                   ~add_predictions(data=data.frame(votes=seq_range(.x$votes,by=.25)),
                                    model=.y,
                                    type="response")
         )
  ) %>%
  unnest(yhat) %>%
  ungroup() %>%
  select(outcomes_collapsed,votes,pred) %>%
  mutate(votes=as.numeric(votes),
         pred=as.numeric(pred))


data_for_d3 <- list(data=tmp %>% mutate(across(where(is.double),as.numeric)) %>% 
                      select(Division,State,votes,prob,prices,outcomes_collapsed) %>%
                      mutate(i = match(Division,sort(unique(Division)))) %>%
                      as.data.frame(),
                    yhat=m)

library(jsonlite)
r2d3(data=toJSON(data_for_d3,
                 dataframe = "rows", auto_unbox = FALSE),
     viewer="browser",
     width = 840,
     height=400,
     container="div",
     dependencies = here("js/d3-tip.js"),
     elementId="linkedScatter",
     script=here("js/linkedScatter.js"))
```

## Seats likely to change hands {#seats-changing-hands}

The following `r nrow(tab_change)` seats have candidates of incumbent parties with IPOWs of less then 50%:

```{r seats-changing-hands,results='asis'}
datatable(tab_change %>%
            mutate(incumbent_tcp=100*incumbent_tcp) %>%
            select(Division,State,
                   Incumbent=incumbent,
                   `Incumbent TCP`=incumbent_tcp,
                   `Incumbent IPOW`=incumbent_prob,
                   Favourite=favorite),
          rownames = FALSE,
          options=list(style="bootstrap4"),
          caption = "") %>%
  formatRound(columns=c(4,5),digits=1)
```

# Appendix

Australian bookmakers tend to use decimal odds, the return to the punter of a
successful unit or one-dollar wager. In general, the more likely the event, the
closer the decimals odds approach 1.00 from above; conversely, the less likely
the event, decimal odds take on increasingly larger values.

If $d = (d_1, \ldots, d_J)'$ are decimal odds over $J$ mutually exclusive and
exhaustive outcomes then the implied probability of event $j \in 1, \ldots, J$
is conventionally recovered as 

\begin{equation} 
  p_j = \frac{1/d_j}{\sum_{k=1}^J 1/d_k}
  (\#eq:normalisation)
\end{equation}

In the context of elections, we refer to $p_j$ as the *implied probability of
winning* or IPOW for party or candidate $j$.

This transformation of decimal odds into IPOWs can be rationalised as follows.
Bookmakers set prices not merely as a function of their beliefs about outcomes,
but also to lock in profits. The most telling case comes from observing that for
coin tosses ahead of cricket matches, bookmakers typically offer prices of $d$ =
1.91 or thereabouts for each of the two outcomes; more surprising is that
gamblers participate in this market at all. This is a case where the *actual*
probabilities held by both bookmakers and punters can be reasonably presumed to
be 50-50 on each of the two outcomes. A fair price on a unit wager is therefore
2.00, with expected value of 1.00 = .5 $\times$ 2.00 + .5 $\times$ 0.

Observe that the fair price of $d$ = 2.00 is simply the inverse of the
probability of $p$ = .5. This result generalises: fair decimal odds are simply
the inverse of the probabilities of the corresponding events, or $d = 1/p$ and
conversely $p = 1/d$.

But bookmakers prices can not be assumed to be fair. For the coin toss example,
the bookmakers' prices of *less* than the fair price of 2.00 reflect their
profit margin. With decimals odds of $d$ = 1.91, the bookmaker will lose 91
cents on each successful dollar wager, but keep \$1.00 on each unsuccessful
wager. This asymmetry in payouts with respect to equally likely events is the
key to the adage that "the house always wins". In this example the bookmaker has
an expected yield of 4.5c cents per dollar waged.

Alternatively, applying the rule that probabilities are the inverses of the
corresponding decimal odds, then with prices of 1.91 on both outcomes, the
bookmaker's apparent probabilities are 0.5236 for each outcome. This clearly
violates the law of total probability (that the probabilities over the set of
possible outcomes sum to one), in this case summing to 1.0471.

The apparent "extra probability" is known as the "over-round" or "vigorish".
Bookmakers prices therefore reflect at least two inputs: (1) probabilities about
events; (2) profit margins [@cortisExpectedValuesVariances2015]. Let $p_j$ be
the bookmakers' privately held probability of event $j$. A profit-motivated
bookmaker offers prices of $d_j = 1/\pi_j$, where $\pi_j = p_j(1+k_j)$ with
$k_j > 0$ the source of the bookmaker's profits.

In the literature assessing the predictive value of betting markets, the
conversion from decimal odds almost always assumes $k_j$ is a constant $k$ over
all events $j$, giving rise to the transformation

$$
\frac{1/d_j}{\sum_j 1/d_j} = \frac{\pi_j}{\sum_j 1/\pi_j} = \frac{p_j(1+k)}{\sum_j p_j(1+k)} = \frac{(1+k)\, p_j}{(1+k)\sum_j p_j} = p_j,
$$ as per equation \@ref(eq:normalisation).

@strumbeljDeterminingProbabilityForecasts2014 and @levittWhyAreGambling2004
survey cases where $k_j$ might reasonably be expected to *not* be constant over
outcomes $j$; examples include information and skill asymmetries between
bookmakers and punters and/or bookmakers seeking to counter insider-trading.
Betting markets with large numbers of gamblers and bookmakers should generally
drive these effects towards zero, resulting in small variability in $k_j$ over
alternatives, validating the mapping from odds to IPOWs in equation
\@ref(eq:normalisation).

Of course, prior research suggests that seat-by-seat markets are thinly traded,
and so we interpret IPOWs in these markets with appropriate caveats. 
Following my earlier work [@jackmanAllThatGlitters2015], one of the goals of this
analysis in its post-election phase will be to assess the calibration of IPOWs
with election outcomes.

# References
